name: Playwright Tests on Railway PR Preview

on:
  deployment_status:

permissions:
  contents: read
  pull-requests: read

jobs:
  resolve-context:
    name: Resolve PR Context
    if: ${{ github.event.deployment_status.state == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.resolve.outputs.should_run }}
      pr_number: ${{ steps.resolve.outputs.pr_number }}
      base_url: ${{ steps.resolve.outputs.base_url }}
    steps:
      - name: Resolve PR and apply run policy
        id: resolve
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const deploymentSha = context.payload.deployment?.sha;

            core.setOutput('should_run', 'false');
            core.setOutput('pr_number', '');
            core.setOutput('base_url', '');

            if (!deploymentSha) {
              core.info('No deployment SHA found in event payload; skipping.');
              return;
            }

            const response = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: deploymentSha,
            });
            const openPrs = response.data.filter((pr) => pr.state === 'open');

            if (openPrs.length === 0) {
              core.info(`No open PR found for SHA ${deploymentSha}; skipping.`);
              return;
            }

            const pr = openPrs.find((candidate) => candidate.head?.sha === deploymentSha) || openPrs[0];
            const labels = pr.labels
              .map((label) => (typeof label === 'string' ? label : label.name))
              .filter(Boolean);
            const hasTestRunLabel = labels.includes('test-run');
            const hasAutoMerge = pr.auto_merge !== null;

            core.setOutput('pr_number', String(pr.number));

            if (!hasTestRunLabel || !hasAutoMerge) {
              core.info(
                `Policy not met for PR #${pr.number}: test-run label=${hasTestRunLabel}, auto-merge enabled=${hasAutoMerge}.`
              );
              return;
            }

            const baseUrl =
              context.payload.deployment_status?.environment_url ||
              context.payload.deployment_status?.target_url ||
              '';

            if (!baseUrl) {
              core.setFailed(
                'Deployment succeeded but no preview URL was provided in deployment_status.environment_url or deployment_status.target_url.'
              );
              return;
            }

            let parsedUrl;
            try {
              parsedUrl = new URL(baseUrl);
            } catch {
              core.setFailed(`Deployment URL is invalid: ${baseUrl}`);
              return;
            }

            if (!['http:', 'https:'].includes(parsedUrl.protocol)) {
              core.setFailed(`Deployment URL must be http/https: ${parsedUrl.toString()}`);
              return;
            }

            core.setOutput('base_url', parsedUrl.toString());
            core.setOutput('should_run', 'true');
            core.info(`Running Playwright for PR #${pr.number} against ${parsedUrl.toString()}`);

  playwright:
    name: Run Playwright on Railway Preview
    needs: resolve-context
    if: ${{ needs.resolve-context.outputs.should_run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: playwright-railway-pr-${{ github.repository }}-pr-${{ needs.resolve-context.outputs.pr_number }}
      cancel-in-progress: true
    defaults:
      run:
        working-directory: frontend
    env:
      PLAYWRIGHT_BASE_URL: ${{ needs.resolve-context.outputs.base_url }}
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Wait for Railway preview readiness
        run: |
          for i in {1..60}; do
            if curl -fsSL "$PLAYWRIGHT_BASE_URL" > /dev/null; then
              echo "Preview is ready: $PLAYWRIGHT_BASE_URL"
              exit 0
            fi
            echo "Waiting for preview to become ready ($i/60)..."
            sleep 5
          done
          echo "::error::Preview did not become ready in time: $PLAYWRIGHT_BASE_URL"
          exit 1

      - name: Run Playwright tests
        run: npx playwright test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pr-${{ needs.resolve-context.outputs.pr_number }}
          path: frontend/playwright-report
          if-no-files-found: ignore

      - name: Upload Playwright test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results-pr-${{ needs.resolve-context.outputs.pr_number }}
          path: frontend/test-results
          if-no-files-found: ignore
