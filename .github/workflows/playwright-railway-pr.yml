name: "Playwright Tests (label: test-run)"

on:
  pull_request:
    types: [labeled]

permissions:
  contents: read
  pull-requests: write   # needed to remove label
  deployments: read

jobs:
  resolve-and-test:
    if: ${{ github.event.label.name == 'test-run' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout PR head SHA
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Resolve Railway preview URL from deployments
        id: url
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const sha = pr.head.sha;

            const sleep = (ms) => new Promise(r => setTimeout(r, ms));
            const deadline = Date.now() + 10 * 60 * 1000; // 10 minutes

            let baseUrl = "";

            while (Date.now() < deadline && !baseUrl) {
              const depResp = await github.rest.repos.listDeployments({
                owner, repo, sha, per_page: 10,
              });

              const deployments = depResp.data || [];
              if (deployments.length) {
                const newest = deployments[0];

                const stResp = await github.rest.repos.listDeploymentStatuses({
                  owner, repo, deployment_id: newest.id, per_page: 20,
                });

                const statuses = stResp.data || [];
                const success = statuses.find(s => s.state === "success");
                if (success) {
                  baseUrl = success.environment_url || success.target_url || "";
                }
              }

              if (!baseUrl) {
                core.info("No successful deployment URL yet; retrying in 10s...");
                await sleep(10_000);
              }
            }

            if (!baseUrl) {
              core.setFailed(`No successful deployment URL found for SHA ${sha}`);
              return;
            }

            // basic validation
            let u;
            try { u = new URL(baseUrl); } catch { core.setFailed(`Invalid URL: ${baseUrl}`); return; }
            if (!["http:", "https:"].includes(u.protocol)) {
              core.setFailed(`URL must be http/https: ${u.toString()}`);
              return;
            }

            core.setOutput("base_url", u.toString());

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Wait for preview readiness
        env:
          PLAYWRIGHT_BASE_URL: ${{ steps.url.outputs.base_url }}
        run: |
          for i in {1..60}; do
            if curl -fsSL "$PLAYWRIGHT_BASE_URL" > /dev/null; then
              echo "Preview is ready: $PLAYWRIGHT_BASE_URL"
              exit 0
            fi
            echo "Waiting ($i/60): $PLAYWRIGHT_BASE_URL"
            sleep 5
          done
          echo "::error::Preview did not become ready: $PLAYWRIGHT_BASE_URL"
          exit 1

      - name: Run Playwright tests
        env:
          PLAYWRIGHT_BASE_URL: ${{ steps.url.outputs.base_url }}
          CI: true
        run: npx playwright test

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pr-${{ github.event.pull_request.number }}
          path: frontend/playwright-report
          if-no-files-found: ignore

      - name: Upload Playwright test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results-pr-${{ github.event.pull_request.number }}
          path: frontend/test-results
          if-no-files-found: ignore

      - name: Remove test-run label (one-shot trigger)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;

            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: prNumber,
                name: "test-run",
              });
              core.info("Removed label: test-run");
            } catch (e) {
              // If label already removed or permissions issue, don't mask test failure
              core.warning(`Could not remove label 'test-run': ${e.message}`);
            }
